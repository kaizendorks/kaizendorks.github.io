(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{399:function(s,e,t){"use strict";t.r(e);var a=t(4),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"troubleshooting-dns-in-kubernetes-cheatsheet"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting-dns-in-kubernetes-cheatsheet"}},[s._v("#")]),s._v(" Troubleshooting DNS in Kubernetes Cheatsheet")]),s._v(" "),t("p",[s._v("You have an application running in a Kubernetes cluster and you start experiencing DNS resolution issues. If that's your case, I have found the following steps the most helpful when investigating these issues.")]),s._v(" "),t("p",[s._v("I hope it can help you too and remember, "),t("em",[s._v("it's always DNS")]),s._v(".")]),s._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",[s._v("Beyond this cheatsheet, you have a more comprehensive guide in the official "),t("a",{attrs:{href:"https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Kubernetes docs"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"_1-use-a-container-with-the-necessary-utilities"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-use-a-container-with-the-necessary-utilities"}},[s._v("#")]),s._v(" 1. Use a container with the necessary utilities")]),s._v(" "),t("p",[s._v("Quickly create a Pod that uses a container with the utilities such as "),t("code",[s._v("nslookup")]),s._v(" or "),t("code",[s._v("dig")]),s._v(" that you will need. (You can skip this if you already have a container with these utilities)")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v("EOF "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" kubectl apply -f -\napiVersion: v1\nkind: Pod\nmetadata:\n  name: dnsutils\n  namespace: default\nspec:\n  containers:\n  - name: dnsutils\n    image: gcr.io/kubernetes-e2e-test-images/dnsutils:1.3\n    command:\n      - "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v("\n      - "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3600"')]),s._v("\n    imagePullPolicy: IfNotPresent\n  restartPolicy: Always\nEOF\n")])])]),t("h2",{attrs:{id:"_2-check-the-dns-configuration-applied-to-pods"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-check-the-dns-configuration-applied-to-pods"}},[s._v("#")]),s._v(" 2. Check the DNS configuration applied to Pods")]),s._v(" "),t("p",[s._v("Check the contents of the "),t("code",[s._v("/etc/resolv.conf")]),s._v(" file inside the container.")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -ti dnsutils -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/resolv.conf\nnameserver "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.43")]),s._v(".0.10\nsearch default.svc.cluster.local svc.cluster.local cluster.local "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". might have other domains here"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\noptions ndots:5\n")])])]),t("p",[s._v("You want to make sure the "),t("code",[s._v("nameserver")]),s._v(" IP corresponds to the IP of the "),t("code",[s._v("kube-dns")]),s._v(" service and that the service is up and running!")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" kube-dns -n kube-system\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                  AGE\nkube-dns   ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.43")]),s._v(".0.10   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),s._v("/UDP,53/TCP,9153/TCP   337d\n")])])]),t("h2",{attrs:{id:"_3-check-if-you-can-resolve-the-address"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-check-if-you-can-resolve-the-address"}},[s._v("#")]),s._v(" 3. Check if you can resolve the address")]),s._v(" "),t("p",[s._v("Using the "),t("code",[s._v("dnsutils")]),s._v(" container you added in the first step, attemp to resolve a domain using "),t("code",[s._v("nslookup")]),s._v(" as in:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -ti dnsutils -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nslookup")]),s._v(" google.com\nServer:         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.43")]),s._v(".0.10\nAddress:        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.43")]),s._v(".0.10"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53")]),s._v("\n\nNon-authoritative answer:\nName:   google.com\nAddress: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.58")]),s._v(".210.46\nName:   google.com\nAddress: 2a00:1450:4009:800::200e\n")])])]),t("div",{staticClass:"custom-block tip"},[t("p",[s._v("Replace "),t("code",[s._v("google.com")]),s._v(" with the URL you are having trouble with.\nThis can either be annother external URL or an internal URL such as "),t("code",[s._v("my-service.my-namespace")]),s._v(".")])]),s._v(" "),t("p",[s._v("If you cannot resolve it, make sure the "),t("code",[s._v("kube-dns")]),s._v(" service is healthy, and that the Pods behind are running.")]),s._v(" "),t("p",[s._v("Check also if there is any error reported by those Pods, which are the ones with the label "),t("code",[s._v("k8s-app=kube-dns")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl logs -n kube-system -l k8s-app"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-dns --tail "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n")])])]),t("h2",{attrs:{id:"_4-trace-the-resolution-and-check-for-latencies"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-trace-the-resolution-and-check-for-latencies"}},[s._v("#")]),s._v(" 4. Trace the resolution and check for latencies")]),s._v(" "),t("p",[s._v("You can use the "),t("code",[s._v("dig")]),s._v(" tool to trace the DNS resolution process and inspect the latencies of each network hoop.")]),s._v(" "),t("p",[s._v("For example, you can trace ther resolution of "),t("code",[s._v("google.com")]),s._v(" using the "),t("code",[s._v("dig google.com")]),s._v(" command. From the output below, we can see it ends resolving to the expected IP 216.58.210.46 and the response time:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("$ kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -ti dnsutils -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dig")]),s._v(" google.com\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" DiG "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9.11")]),s._v(".6-P1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" google.com\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" global options: +cmd\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Got answer:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" -"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v("HEADER"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<-")]),s._v(" opcode: QUERY, status: NOERROR, id: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29263")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" flags: qr rd ra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" QUERY: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", ANSWER: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", AUTHORITY: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(", ADDITIONAL: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" OPT PSEUDOSECTION:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" EDNS: version: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", flags:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" udp: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" COOKIE: 0fbb77fd5accad54 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("echoed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" QUESTION SECTION:\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("google.com.                    IN      A\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ANSWER SECTION:\ngoogle.com.             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      A       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.58")]),s._v(".210.46\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" AUTHORITY SECTION:\ngoogle.com.             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      NS      ns3.google.com.\ngoogle.com.             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      NS      ns2.google.com.\ngoogle.com.             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      NS      ns4.google.com.\ngoogle.com.             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      NS      ns1.google.com.\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" ADDITIONAL SECTION:\nns2.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      AAAA    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v(":4860:4802:34::a\nns1.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      AAAA    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v(":4860:4802:32::a\nns4.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      AAAA    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v(":4860:4802:38::a\nns1.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      A       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.239")]),s._v(".32.10\nns3.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      A       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.239")]),s._v(".36.10\nns4.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      A       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.239")]),s._v(".38.10\nns2.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      A       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("216.239")]),s._v(".34.10\nns3.google.com.         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v("      IN      AAAA    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2001")]),s._v(":4860:4802:36::a\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" Query time: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" msec\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" SERVER: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.43")]),s._v(".0.10"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#53(10.43.0.10)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" WHEN: Fri Nov "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":19:03 UTC "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" MSG SIZE  rcvd: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("517")]),s._v("\n")])])]),t("p",[s._v("If you want to go deeper, you can use "),t("code",[s._v("dig +trace")]),s._v(" and see the intermediate steps in the resolution:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" -ti dnsutils -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dig")]),s._v(" +trace google.com\n")])])]),t("h2",{attrs:{id:"using-rancher"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#using-rancher"}},[s._v("#")]),s._v(" Using rancher?")]),s._v(" "),t("p",[s._v("I have been hit "),t("a",{attrs:{href:"https://github.com/rancher/rancher/issues/23284",target:"_blank",rel:"noopener noreferrer"}},[s._v("by this issue"),t("OutboundLink")],1),s._v(" whereby Pods suddenly start getting their IPs assigned in the 172.17.0.0 range.")]),s._v(" "),t("p",[s._v("When this happenes, they are in the wrong network and thus become unreachable from other Pods. Eventually this might affect one or all of the Pods in the "),t("code",[s._v("kube-dns")]),s._v(" system, which results in intermittent or permanent DNS resolution issues until the Pods are recreated.")])])}),[],!1,null,null,null);e.default=n.exports}}]);